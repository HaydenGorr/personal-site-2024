FROM node:18

# Accept build arguments
ARG PORT
ARG REVALIDATE_TIME_SECS
ARG LOCAL_ACCESS_CMS
ARG USER_ACCESS_CMS
ARG LOCAL_ACCESS_AI
ARG USER_ACCESS_AI
ARG VERSION

# Set environment variables for the build
ENV PORT=${PORT}
ENV REVALIDATE_TIME_SECS=${REVALIDATE_TIME_SECS}
ENV LOCAL_ACCESS_CMS=${LOCAL_ACCESS_CMS}
ENV USER_ACCESS_CMS=${USER_ACCESS_CMS}
ENV LOCAL_ACCESS_AI=${LOCAL_ACCESS_AI}
ENV USER_ACCESS_AI=${USER_ACCESS_AI}
ENV VERSION=${USER_ACCESS_AI}

WORKDIR /app

# Install main dependencies
COPY package*.json ./
RUN npm install --legacy-peer-deps

WORKDIR /app/webserver

COPY . .

RUN npm run build

EXPOSE ${PORT}

CMD npm run dev -- -p ${PORT}